#!/usr/bin/env bash
set -e

ver="$1"
case "$ver" in
  bullseye) ;;
  *) echo "Unsupported Debian version: $ver"; exit 1;;
esac

myarch="`uname -m`"

arch="$2"
case "$arch" in
  i386) ;;
  amd64) echo "Cannot explicitly request architecture: $arch"; exit 1;;
  arm64) echo "Cannot explicitly request architecture: $arch"; exit 1;;
  *) echo "Unsupported Debian architecture: $arch"; exit 1;;
esac

if [ -n "$arch" ]; then
  tag="bab/debian:${ver}_${arch}"
else
  tag="bab/debian:$ver"
  arch=`dpkg --print-architecture`
fi

echo "Preparing Debian $ver ($arch) as $tag ..."
echo
./mkimage.sh -t "$tag" debootstrap --arch="$arch" "$ver"

exit 0
