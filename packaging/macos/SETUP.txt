-----------------
PACKAGING SUMMARY
-----------------

To build MacOS binaries for release:

- Copy regina-X.Y.tar.gz and this macos/ directory to the build machine.

- On the build machine (typically a guest VM):

    cd
    rm -rf Regina.app
    tar -zxf regina-X.Y.tar.gz

    cd regina-X.Y
    change PACKAGE_VERSION in CMakeLists.txt (if we are between releases)
    path/to/macos/build-mac

    cd
    tar -zcf regina.tgz Regina.app
    copy regina.tgz to the signing machine

- On the signing machine (typically the host machine):

    cd temporary_path
    tar -zxf path/to/regina.tgz

    cd path/to/macos
    change version in dmg-maker.py (if we are between releases)
    ./sign-all temporary_path/Regina.app
    ./dmg_maker.py temporary_path/Regina.app

    collect Regina-X.Y.dmg for distribution

-----------------------
BUILDING VIRTUALBOX VMs
-----------------------

HIGH SIERRA:

0. Download the High Sierra installer through the Purchased tab in the App Store.

1. Create an installer ISO from the App Store app:

  hdiutil create -o /tmp/High\ Sierra.cdr -size 7316m -layout SPUD -fs HFS+J
  hdiutil attach /tmp/High\ Sierra.cdr.dmg -noverify -mountpoint /Volumes/install_build
  sudo /Applications/Install\ macOS\ High\ Sierra.app/Contents/Resources/createinstallmedia --volume /Volumes/install_build
  hdiutil detach /Volumes/Install\ macOS\ High\ Sierra
  hdiutil convert /tmp/High\ Sierra.cdr.dmg -format UDTO -o 'High Sierra'.iso
  rm /tmp/High\ Sierra.cdr.dmg
  mv High\ Sierra.iso.cdr High\ Sierra.iso

2. Create the VM:

- Non-default options: 2 CPUs, 128MB video memory

- Ensure solid state drive is deselected

3. Install the OS:

- Boot from ISO

- Open Disk Utility to erase (and thereby format) the virtual drive

- Run the installer

- The automatic reboot will (incorrectly) reboot to the ISO, not the HDD:
  + Hammer F12 when booting the machine to open the VirtualBox boot manager
  + Select: Boot Maintenance Manager -> Boot from File -> ...HD(2,GPT)... ->
    macOS Install Data -> Locked Files -> Boot Files -> boot.efi

4. Compress the HD:

- The VDI will take up twice the necessary space due to deleted installer files.

- Boot from the ISO again, open Terminal, and run:

  diskutil list (to find out which device is the virtual HD)
 â€¨diskutil secureErase freespace 0 disk0s2 (to overwrite deleted files with 0)

- In the host system, run:

  /Applications/VirtualBox.app/Contents/MacOS/VBoxManage modifymedium disk path/to/guest.vdi --compact

Sources for steps 1-3:

http://tobiwashere.de/2017/10/virtualbox-how-to-create-a-macos-high-sierra-vm-to-run-on-a-mac-host-system/


SIERRA (currently broken):

0. Download the Sierra installer through the Purchased tab in the App Store:

  git clone https://github.com/mas-cli/mas.git
  scripts/build
  build/mas install 1127487414

- Kill the installer when it runs automatically, since quitting it normally may
  result in the installer being deleted.

1. Create an installer ISO from the App Store app:

  hdiutil create -o /tmp/Sierra.cdr -size 7316m -layout SPUD -fs HFS+J
  hdiutil attach /tmp/Sierra.cdr.dmg -noverify -mountpoint /Volumes/install_build
  sudo /Applications/Install\ macOS\ Sierra.app/Contents/Resources/createinstallmedia --volume /Volumes/install_build --applicationpath /Applications/Install\ macOS\ Sierra.app
  hdiutil detach /Volumes/Install\ macOS\ Sierra
  hdiutil convert /tmp/Sierra.cdr.dmg -format UDTO -o Sierra.iso
  rm /tmp/Sierra.cdr.dmg
  mv Sierra.iso.cdr Sierra.iso

2. Problems from here:

- ISO does not boot on its own (gets stuck after gIOScreenLockState for Sierra ISO >= 10.12.4)

- El Capitan upgrade from the ISO installs but reboots back into El Capitan, not Sierra

- Cannot sign into the App Store to download Sierra directly (cannot verify identity of this mac)


EL CAPITAN:

0. Download the El Capitan installer through the Purchased tab in the App Store.

- Kill the installer when it runs automatically, since quitting it normally may
  result in the installer being deleted.

1. Create an installer ISO from the App Store app:

  hdiutil create -o /tmp/El\ Capitan.cdr -size 7316m -layout SPUD -fs HFS+J
  hdiutil attach /tmp/El\ Capitan.cdr.dmg -noverify -mountpoint /Volumes/install_build
  sudo /Applications/Install\ OS\ X\ El\ Capitan.app/Contents/Resources/createinstallmedia --volume /Volumes/install_build --applicationpath /Applications/Install\ OS\ X\ El\ Capitan.app
  hdiutil detach /Volumes/Install\ OS\ X\ El\ Capitan
  hdiutil convert /tmp/El\ Capitan.cdr.dmg -format UDTO -o El\ Capitan.iso
  rm /tmp/El\ Capitan.cdr.dmg
  mv El\ Capitan.iso.cdr El\ Capitan.iso

2. Add .IAProductInfo as required for read-only install media:

- Find the installer's volume UUID:

  hdiutil attach -noverify -nobrowse /Applications/Install\ OS\ X\ El\ Capitan.app/Contents/SharedSupport/InstallESD.dmg
  diskutil info /Volumes/OS\ X\ Install\ ESD | grep 'Volume UUID'
  hdiutil detach /Volumes/OS\ X\ Install\ ESD

- Mount the ISO as a regular user:

  hdiutil attach -noverify -nobrowse El\ Capitan.iso
  cp IAProductInfo /Volumes/Install\ OS\ X\ El\ Capitan/.IAProductInfo
  vim /Volumes/Install\ OS\ X\ El\ Capitan/.IAProductInfo (replace the UUID with the one found above)
  hdiutil detach /Volumes/Install\ OS\ X\ El\ Capitan

3. Create the VM and install the OS:

- Non-default VM options: 2 CPUs, 128MB video memory

- Boot from ISO, which runs the installer automatically

- Use Disk Utility from the installer to erase (and thus format) the virtual drive

- The automatic reboot will (incorrectly) reboot back to the ISO, not the HDD.
  Ejecting the ISO will fix this.


YOSEMITE:

0. Download the Yosemite installer through the Purchased tab in the App Store.

- Kill the installer when it runs automatically, since quitting it normally may
  result in the installer being deleted.

1. Create an installer ISO from the App Store app:

  hdiutil create -o /tmp/Yosemite.cdr -size 7316m -layout SPUD -fs HFS+J
  hdiutil attach /tmp/Yosemite.cdr.dmg -noverify -mountpoint /Volumes/install_build
  sudo /Applications/Install\ OS\ X\ Yosemite.app/Contents/Resources/createinstallmedia --volume /Volumes/install_build --applicationpath /Applications/Install\ OS\ X\ Yosemite.app
  hdiutil detach /Volumes/Install\ OS\ X\ Yosemite
  hdiutil convert /tmp/Yosemite.cdr.dmg -format UDTO -o Yosemite.iso
  rm /tmp/Yosemite.cdr.dmg
  mv Yosemite.iso.cdr Yosemite.iso

2. Add .IAProductInfo as required for read-only install media:

- Find the installer's volume UUID:

  hdiutil attach -noverify -nobrowse /Applications/Install\ OS\ X\ Yosemite.app/Contents/SharedSupport/InstallESD.dmg
  diskutil info /Volumes/OS\ X\ Install\ ESD | grep 'Volume UUID'
  hdiutil detach /Volumes/OS\ X\ Install\ ESD

- Mount the ISO as a regular user:

  hdiutil attach -noverify -nobrowse Yosemite.iso
  cp IAProductInfo /Volumes/Install\ OS\ X\ Yosemite/.IAProductInfo
  vim /Volumes/Install\ OS\ X\ Yosemite/.IAProductInfo (replace the UUID with the one found above)
  hdiutil detach /Volumes/Install\ OS\ X\ Yosemite

3. Create the VM and install the OS:

- Non-default VM options: 2 CPUs, 128MB video memory

- The VM requires a chipset override:

  /Applications/VirtualBox.app/Contents/MacOS/VBoxManage modifyvm Yosemite --cpuidset 00000001 000306a9 04100800 7fbae3ff bfebfbff

- Boot from ISO, which runs the installer automatically

- Use Disk Utility from the installer to erase (and thus format) the virtual drive

